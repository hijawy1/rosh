/*
 CSS Class Applier module for Rangy.
 Adds, removes and toggles CSS classes on Ranges and Selections

 Part of Rangy, a cross-browser JavaScript range and selection library
 http://code.google.com/p/rangy/

 Depends on Rangy core.

 Copyright 2012, Tim Down
 Licensed under the MIT license.
 Version: 1.2.3
 Build date: 26 February 2012
*/
rangy.createModule("CssClassApplier",function(e,t){function n(e,t){return e.className&&RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function s(e,t){e.className?n(e,t)||(e.className+=" "+t):e.className=t}function i(e){return e.split(/\s+/).sort().join(" ")}function a(e,t){return i(e.className)==i(t.className)}function r(e){for(var t=e.parentNode;e.hasChildNodes();)t.insertBefore(e.firstChild,e);t.removeChild(e)}function o(e,t){var n=e.cloneRange();n.selectNodeContents(t);var s=n.intersection(e);return s=s?s.toString():"",n.detach(),""!=s}function l(e){return e.getNodes([3],function(t){return o(e,t)})}function d(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,s,i=0,a=e.attributes.length;i<a;++i)if("class"!=(s=(n=e.attributes[i]).name)){if(s=t.attributes.getNamedItem(s),n.specified!=s.specified)return!1;if(n.specified&&n.nodeValue!==s.nodeValue)return!1}return!0}function h(e,t){for(var n,s=0,i=e.attributes.length;s<i;++s)if(n=e.attributes[s].name,(!t||!v.arrayContains(t,n))&&e.attributes[s].specified&&"class"!=n)return!0;return!1}function u(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||T(e)&&!T(e.parentNode))}function p(e){return(T(e)||1!=e.nodeType&&T(e.parentNode))&&!u(e)}function c(e){return e&&1==e.nodeType&&!S.test(y(e,"display"))}function f(e){if(0==e.data.length)return!0;if(A.test(e.data))return!1;switch(y(e.parentNode,"whiteSpace")){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return c(e.previousSibling)||c(e.nextSibling)}function g(e,n,s,i){var a,r,o=0==s;if(v.isAncestorOf(n,e))return e;if(v.isCharacterDataNode(n))if(0==s)s=v.getNodeIndex(n),n=n.parentNode;else{if(s!=n.length)throw t.createError("splitNodeAt should not be called with offset in the middle of a data node ("+s+" in "+n.data);s=v.getNodeIndex(n)+1,n=n.parentNode}r=n;var l=s;if(r=v.isCharacterDataNode(r)?0==l?!!r.previousSibling:l!=r.length||!!r.nextSibling:l>0&&l<r.childNodes.length){if(!a){for((a=n.cloneNode(!1)).id&&a.removeAttribute("id");o=n.childNodes[s];)a.appendChild(o);v.insertAfter(a,n)}return n==e?a:g(e,a.parentNode,v.getNodeIndex(a),i)}return e!=n?(a=n.parentNode,n=v.getNodeIndex(n),o||n++,g(e,a,n,i)):e}function N(e){var t=e?"nextSibling":"previousSibling";return function(n,s){var i=n.parentNode,r=n[t];if(r){if(r&&3==r.nodeType)return r}else if(s&&(r=i[t])&&1==r.nodeType&&i.tagName==r.tagName&&a(i,r)&&d(i,r))return r[e?"firstChild":"lastChild"];return null}}function m(e){this.firstTextNode=(this.isElementMerge=1==e.nodeType)?e.lastChild:e,this.textNodes=[this.firstTextNode]}function C(e,t,n){this.cssClass=e;var s,a,r=null;if("object"==typeof t&&null!==t){for(n=t.tagNames,r=t.elementProperties,s=0;a=R[s++];)t.hasOwnProperty(a)&&(this[a]=t[a]);s=t.normalize}else s=t;for(var o in this.normalize=void 0===s||s,this.attrExceptions=[],s=document.createElement(this.elementTagName),this.elementProperties={},r)r.hasOwnProperty(o)&&(E.hasOwnProperty(o)&&(o=E[o]),s[o]=r[o],this.elementProperties[o]=s[o],this.attrExceptions.push(o));if(this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?i(this.elementProperties.className+" "+e):e,this.applyToAnyTagName=!1,"string"==(e=typeof n))"*"==n?this.applyToAnyTagName=!0:this.tagNames=n.toLowerCase().replace(/^\s\s*/,"").replace(/\s\s*$/,"").split(/\s*,\s*/);else if("object"==e&&"number"==typeof n.length)for(this.tagNames=[],s=0,e=n.length;s<e;++s)"*"==n[s]?this.applyToAnyTagName=!0:this.tagNames.push(n[s].toLowerCase());else this.tagNames=[this.elementTagName]}e.requireModules(["WrappedSelection","WrappedRange"]);var y,T,v=e.dom,b=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){t.className&&(t.className=t.className.replace(RegExp("(?:^|\\s)"+n+"(?:\\s|$)"),e))}}();"undefined"!=typeof window.getComputedStyle?y=function(e,t){return v.getWindow(e).getComputedStyle(e,null)[t]}:"undefined"!=typeof document.documentElement.currentStyle?y=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),T="boolean"==typeof document.createElement("div").isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return!(!e||1!=e.nodeType||"false"==e.contentEditable)&&("true"==e.contentEditable||T(e.parentNode))};var S=/^inline(-block|-table)?$/i,A=/[^\r\n\t\f \u200B]/,x=N(!1),w=N(!0);m.prototype={doMerge:function(){for(var e,t,n=[],s=0,i=this.textNodes.length;s<i;++s)t=(e=this.textNodes[s]).parentNode,n[s]=e.data,s&&(t.removeChild(e),t.hasChildNodes()||t.parentNode.removeChild(t));return this.firstTextNode.data=n.join("")},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;t<n;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var R=["elementTagName","ignoreWhiteSpace","applyToEditableOnly"],E={"class":"className"};C.prototype={elementTagName:"span",elementProperties:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,hasClass:function(e){return 1==e.nodeType&&v.arrayContains(this.tagNames,e.tagName.toLowerCase())&&n(e,this.cssClass)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e,this.cssClass))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||p(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&f(e)},postApply:function(e,t,n){for(var s,i,a,r=e[0],o=e[e.length-1],l=[],d=r,h=o,u=0,p=o.length,c=0,f=e.length;c<f;++c)i=e[c],(a=x(i,!n))?(s||(s=new m(a),l.push(s)),s.textNodes.push(i),i===r&&(u=(d=s.firstTextNode).length),i===o&&(h=s.firstTextNode,p=s.getLength())):s=null;if((e=w(o,!n))&&(s||(s=new m(o),l.push(s)),s.textNodes.push(e)),l.length){for(c=0,f=l.length;c<f;++c)l[c].doMerge();t.setStart(d,u),t.setEnd(h,p)}},createContainer:function(t){return t=t.createElement(this.elementTagName),e.util.extend(t,this.elementProperties),s(t,this.cssClass),t},applyToTextNode:function(e){var t=e.parentNode;1==t.childNodes.length&&v.arrayContains(this.tagNames,t.tagName.toLowerCase())?s(t,this.cssClass):(t=this.createContainer(v.getDocument(e)),e.parentNode.insertBefore(t,e),t.appendChild(e))},isRemovable:function(e){var t;if(t=e.tagName.toLowerCase()==this.elementTagName){if(t=i(e.className)==this.elementSortedClassName){var n;e:{for(n in t=this.elementProperties)if(t.hasOwnProperty(n)&&e[n]!==t[n]){n=!1;break e}n=!0}t=n&&!h(e,this.attrExceptions)&&this.isModifiable(e)}t=t}return t},undoToTextNode:function(e,t,n){t.containsNode(n)||((e=t.cloneRange()).selectNode(n),e.isPointInRange(t.endContainer,t.endOffset)&&(g(n,t.endContainer,t.endOffset,[t]),t.setEndAfter(n)),e.isPointInRange(t.startContainer,t.startOffset)&&(n=g(n,t.startContainer,t.startOffset,[t]))),this.isRemovable(n)?r(n):b(n,this.cssClass)},applyToRange:function(e){e.splitBoundaries();var t=l(e);if(t.length){for(var n,s=0,i=t.length;s<i;++s)n=t[s],!this.isIgnorableWhiteSpaceNode(n)&&!this.getSelfOrAncestorWithClass(n)&&this.isModifiable(n)&&this.applyToTextNode(n);e.setStart(t[0],0),n=t[t.length-1],e.setEnd(n,n.length),this.normalize&&this.postApply(t,e,!1)}},applyToSelection:function(t){t=t||window;var n,s=(t=e.getSelection(t)).getAllRanges();t.removeAllRanges();for(var i=s.length;i--;)n=s[i],this.applyToRange(n),t.addRange(n)},undoToRange:function(e){e.splitBoundaries();var t,n,s=l(e),i=s[s.length-1];if(s.length){for(var a=0,r=s.length;a<r;++a)t=s[a],(n=this.getSelfOrAncestorWithClass(t))&&this.isModifiable(t)&&this.undoToTextNode(t,e,n),e.setStart(s[0],0),e.setEnd(i,i.length);this.normalize&&this.postApply(s,e,!0)}},undoToSelection:function(t){t=t||window;var n,s=(t=e.getSelection(t)).getAllRanges();t.removeAllRanges();for(var i=0,a=s.length;i<a;++i)n=s[i],this.undoToRange(n),t.addRange(n)},getTextSelectedByRange:function(e,t){var n=t.cloneRange();n.selectNodeContents(e);var s=n.intersection(t);return s=s?s.toString():"",n.detach(),s},isAppliedToRange:function(e){if(e.collapsed)return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);for(var t,n=e.getNodes([3]),s=0;t=n[s++];)if(!this.isIgnorableWhiteSpaceNode(t)&&o(e,t)&&this.isModifiable(t)&&!this.getSelfOrAncestorWithClass(t))return!1;return!0},isAppliedToSelection:function(t){t=t||window;for(var n=(t=e.getSelection(t).getAllRanges()).length;n--;)if(!this.isAppliedToRange(t[n]))return!1;return!0},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},detach:function(){}},C.util={hasClass:n,addClass:s,removeClass:b,hasSameClasses:a,replaceWithOwnChildren:r,elementsHaveSameNonClassAttributes:d,elementHasNonClassAttributes:h,splitNodeAt:g,isEditableElement:T,isEditingHost:u,isEditable:p},e.CssClassApplier=C,e.createCssClassApplier=function(e,t,n){return new C(e,t,n)}});